package org.ccci.obiee.client.init;

import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationTargetException;
import java.net.URL;

import javax.xml.namespace.QName;
import javax.xml.ws.Service;
import javax.xml.ws.WebServiceClient;

import com.google.common.base.Throwables;

public class AnswersServiceFactory
{
    public <T extends Service> T buildService(Class<T> serviceClass)
    {
        URL wsdlLocation = getClass().getResource("/wsdl/siebel-analytics-web.wsdl");
        assert wsdlLocation != null;
        QName serviceName = new QName(getTargetNamespaceURI(serviceClass), getServiceName(serviceClass));
        return construct(serviceClass, wsdlLocation, serviceName);
    }

    private <T> T construct(Class<T> serviceClass, URL wsdlLocation, QName serviceName) 
    {
        Constructor<T> constructor;
        try
        {
            constructor = serviceClass.getConstructor(URL.class, QName.class);
        }
        catch (NoSuchMethodException e)
        {
            throw new RuntimeException("can't find service constructor taking (URL, QName).  Was the service class generated by the JAX-WS RI?", e);
        }
        try
        {
            return constructor.newInstance(wsdlLocation, serviceName);
        }
        catch (InstantiationException e)
        {
            throw Throwables.propagate(e);
        }
        catch (IllegalAccessException e)
        {
            throw Throwables.propagate(e);
        }
        catch (InvocationTargetException e)
        {
            throw Throwables.propagate(e.getCause());
        }
    }

    private String getServiceName(Class<? extends Service> serviceClass)
    {
        return serviceClass.getAnnotation(WebServiceClient.class).name();
    }

    private String getTargetNamespaceURI(Class<? extends Service> serviceClass)
    {
        return serviceClass.getAnnotation(WebServiceClient.class).targetNamespace();
    }
}
